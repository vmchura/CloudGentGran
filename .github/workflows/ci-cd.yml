name: Debug OIDC Token

on:
  workflow_dispatch:  # Manual trigger for testing
  push:
    branches: [ develop ]
    paths: [ 'debug-oidc.yml' ]  # Only run when this file changes

# REQUIRED for OIDC authentication with AWS
permissions:
  id-token: write
  contents: read

jobs:
  debug-oidc-token:
    name: Debug OIDC Token Claims
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug OIDC Token Claims
        run: |
          echo "üîç GitHub Actions OIDC Token Debug Information"
          echo "=============================================="
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Ref: $GITHUB_REF"
          echo "SHA: $GITHUB_SHA"
          echo "Actor: $GITHUB_ACTOR"
          echo "Event Name: $GITHUB_EVENT_NAME"
          echo "Workflow: $GITHUB_WORKFLOW"
          echo "Job: $GITHUB_JOB"
          echo "Run ID: $GITHUB_RUN_ID"
          echo "Run Number: $GITHUB_RUN_NUMBER"
          echo ""
          echo "Expected Subject: repo:$GITHUB_REPOSITORY:ref:$GITHUB_REF"
          echo ""
          echo "AWS Configuration:"
          echo "Account ID from secret: ${{ secrets.AWS_ACCOUNT_ID }}"
          echo "Expected Role ARN: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/catalunya-github-dbt-role-dev"

      - name: Try to get OIDC token (will fail but show useful info)
        uses: aws-actions/configure-aws-credentials@v4
        continue-on-error: true
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/catalunya-github-dbt-role-dev
          role-session-name: GitHubActions-Debug-Session
          aws-region: eu-west-1

      - name: Show detailed error information
        if: failure()
        run: |
          echo "üö® OIDC Token assumption failed"
          echo "This gives us information about what GitHub is actually sending"
          echo ""
          echo "Expected conditions in AWS:"
          echo "  token.actions.githubusercontent.com:aud = sts.amazonaws.com"
          echo "  token.actions.githubusercontent.com:sub = repo:$GITHUB_REPOSITORY:ref:$GITHUB_REF"
          echo ""
          echo "If this job fails, check the AWS CloudTrail logs or try the more permissive trust policy"