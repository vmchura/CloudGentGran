# DBT Docker Compose for Catalunya Data Pipeline
# Connects to existing LocalStack running from root docker-compose.local.yaml
# Usage: docker-compose up --build

version: '3.8'

services:
  dbt:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: catalunya-dbt
    volumes:
      # Mount the entire mart project
      - ./mart:/opt/dbt
      # Mount LocalStack S3 buckets via the s3fs mounts
      - ../localstack/s3-mounts/catalunya-data-dev:/mnt/s3-data:ro
      - ../localstack/s3-mounts/catalunya-catalog-dev:/mnt/s3-catalog:ro
      - ../localstack/s3-mounts/catalunya-athena-results-dev:/mnt/s3-results:rw
    environment:
      - DBT_PROJECT_DIR=/opt/dbt
      - DBT_PROFILES_DIR=/home/dbt/.dbt
      # AWS/LocalStack configuration for Athena
      - AWS_ENDPOINT_URL=http://localstack:4566
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=eu-west-1
      # DBT Environment Variables for bucket names
      - DATA_BUCKET=catalunya-data-dev
      - CATALOG_BUCKET=catalunya-catalog-dev
    working_dir: /opt/dbt
    command: tail -f /dev/null
    networks:
      - cloudgentgran-local
    # Connect to existing LocalStack service
    external_links:
      - cloudgentgran-localstack:localstack

networks:
  cloudgentgran-local:
    external: true